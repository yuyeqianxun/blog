# TCP/IP 通信传输流
![TCP/IP](https://note.youdao.com/yws/public/resource/fefa04f064f159e4a063a61949288b11/xmlnote/C8ACE7C9AF0448058BB5CD535F780693/14996)

计算机与网络设备要相互通信，双方就必须基于相同的方法。比如，如何探测到通信目标、由哪一边先发起通信、使用哪种语言进行通信、怎样结束通信等规则都需要事先确定。不同的硬件、操作系统之间的通信，所有的这一切都需要一种规则。而我们就把这种规则称为协议（protocol）。
TCP/IP 是互联网相关的各类协议族的总称，比如：TCP，UDP，IP，FTP，HTTP，ICMP，SMTP 等都属于 TCP/IP 族内的协议。
TCP/IP模型是互联网的基础，它是一系列网络协议的总称。这些协议可以划分为四层，分别为链路层、网络层、传输层和应用层。

- 链路层：负责封装和解封装IP报文，发送和接受ARP/RARP报文等。
- 网络层：负责路由以及把分组报文发送给目标网络或主机。
- 传输层：负责对报文进行分组和重组，并以TCP或UDP协议格式封装报文。
- 应用层：负责向用户提供应用程序，比如HTTP、FTP、Telnet、DNS、SMTP等。

![TCP/IP](https://note.youdao.com/yws/public/resource/fefa04f064f159e4a063a61949288b11/xmlnote/F56F89C36D824C158378D3B6E2529F1A/14998)

### UDP
1. 无连接，传输数据之前源端和终端不建立连接，当它想传送时就简单地去抓取来自应用程序的数据，并尽可能快地把它扔到网络上。
  - 在发送端，UDP传送数据的速度仅仅是受应用程序生成数据的速度、计算机的能力和传输带宽的限制
  - 在接收端，UDP把每个消息段放在队列中，应用程序每次从队列中读一个消息段
2. 面向报文，发送方的UDP对报文添加首部后就向下交付给IP层。既不拆分，也不合并，而是保留这些报文的边界，因此，应用程序需要选择合适的报文大小。
3. 无阻塞，一直会以恒定的速度发送数据
4. 不可靠，无论网络条件，UDP会以恒定速度发送报文。这样实现的弊端就是在网络条件不好的情况下可能会导致丢包，但是优点也很明显，在某些实时性要求高的场景（比如电话会议、多媒体应用）就需要使用 UDP 而不是 TCP。
5. 头部小，仅仅8字节
![UDP头部](https://note.youdao.com/yws/public/resource/fefa04f064f159e4a063a61949288b11/xmlnote/C46887157CE840F4A2AEA8D82B82FF9C/15000)
  - 两个十六位的端口号，分别为源端口（可选字段）和目标端口
  - 整个数据报文的长度
  - 整个数据报文的检验和（IPv4 可选 字段），该字段用于发现头部信息和数据中的错误
6. 一对多，UDP 不止支持一对一的传输方式，同样支持一对多，多对多，多对一的方式，也就是说 UDP 提供了单播，多播，广播的功能。

### TCP
1. 面向连接
  - TCP连接过程(三次握手)
  ![TCP连接](https://note.youdao.com/yws/public/resource/fefa04f064f159e4a063a61949288b11/xmlnote/DD01976745A74AF390DCBE32BF128C5F/15010)
    - 客户端–发送带有SYN标志的数据包–一次握手–服务端
    - 服务端–发送带有SYN/ACK标志的数据包–二次握手–客户端
    - 客户端–发送带有带有ACK标志的数据包–三次握手–服务端
  - TCP断开过程(四次挥手)
  ![TCP断开](https://note.youdao.com/yws/public/resource/fefa04f064f159e4a063a61949288b11/xmlnote/D62352FDB3E94707B375E79E0AEC07D8/15012)
    - 客户端–发送一个FIN，用来关闭客户端到服务器的数据传送
    - 服务器–发回一个ACK，确认序号为收到的序号加1 
    - 服务器–关闭与客户端的连接，发送一个FIN给客户端
    - 客户端–发回ACK报文确认，并将确认序号设置为收到序号加1
2. 头部大
    ![TCP头部](https://note.youdao.com/yws/public/resource/fefa04f064f159e4a063a61949288b11/xmlnote/049872E50A9547B0820651C01B65BA11/15002)
  - 源端口和目的端口 各占两个字节，TCP的分用功能也是通过端口实现的。
  - 序号 占4个字节，范围是[0,232],TCP是面向字节流的，每个字节都是按顺序编号。例如一个报文段，序号字段是201，携带数据长度是100，那么第一个数据的序号就是201，最后一个就是300。当达到最大范围，又从0开始。
  - 确认号 占4个字节，是期望收到对方下一个报文段的第一个字节的序号。若确认号=N,则表示序号N前所有的数据已经正确收到了。
  - 数据偏移 占4位，表示报文段的数据部分的起始位置，距离整个报文段的起始位置的距离。间接的指出首部的长度。
  - 保留 占6位，保留使用，目前为0.
  - URG（紧急） 当URG=1,表明紧急指针字段有效，该报文段有紧急数据，应尽快发送。
  - ACK(确认) 仅当ACK=1时，确认号才有效，连接建立后，所有的报文段ACK都为1。
  - PSH(推送) 接收方接收到PSH=1的报文段，会尽快交付接收应用经常，不再等待整个缓存填满再交付。实际较少使用。
  - RST(复位) RST=1时，表明TCP连接中出现严重差错，必须是否连接，再重连。
  - SYN(同步) 在建立连接时用来同步序号。当SYN=1,ACK=0，则表明是一个连接请求报文段。SYN=1,ACK=1则表示对方同意连接。TCP建立连接用到。
  - FIN(终止) 用来释放一个连接窗口。当FIN=1时，表明此报文段的发送方不再发送数据，请求释放单向连接。TCP断开连接用到。
  - 窗口 占2个字节，表示发送方自己的接收窗口，窗口值用来告诉对方允许发送的数据量。
  - 校验和 占2字节，检验和字段查验范围包括首部和数据部分。
  - 紧急指针 占2字节，URG=1时，紧急指针指出本报文段中的紧急数据的字节数（紧急字节数结束后为普通字节）。
  - 选项 长度可变，最长可达40字节。例如最大报文段长度MSS。MSS指的是数据部分的长度而不是整个TCP报文段长度，MSS默认为536字节长。窗口扩大，时间戳选项等。
3. 仅支持单播传输，每条TCP传输连接只能有两个端点，只能进行点对点的数据传输，不支持多播和广播传输方式。
4. 面向字节流，TCP不像UDP一样那样一个个报文独立地传输，而是在不保留报文边界的情况下以字节流方式进行传输。
5. 拥塞控制，当网络出现拥塞的时候，TCP能够减小向网络注入数据的速率和数量，缓解拥塞
6. 可靠传输，对于可靠传输，判断丢包，误码靠的是TCP的段编号以及确认号。TCP为了保证报文传输的可靠，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的字节发回一个相应的确认(ACK)；如果发送端实体在合理的往返时延(RTT)内未收到确认，那么对应的数据（假设丢失了）将会被重传。
7. 全双工通信，TCP允许通信双方的应用程序在任何时候都能发送数据，因为TCP连接的两端都设有缓存，用来临时存放双向通信的数据。当然，TCP可以立即发送一个数据段，也可以缓存一段时间以便一次发送更多的数据段（最大的数据段大小取决于MSS）

### TCP与UDP比较
|    | UDP | TCP |
| ---------- | ------------ | ------------ |
| 是否连接 | 无连接 | 面向连接 |
| 是否可靠 | 不可靠传输，不使用流量控制和拥塞控制 | 可靠传输，使用流量控制和拥塞控制 |
| 连接对象 | 支持一对一，一对多，多对一和多对多交互通信 | 只能是一对一通信 |
| 传输方式 | 面向报文 | 面向字节流 |
| 首部开销 | 首部开销小，仅8字节 | 首部最小20字节，最大60字节 |
| 适用场景 | 适用于实时应用(IP电话、视频会议、直播等) | 适用于要求可靠传输的应用，例如文件传输 |
  